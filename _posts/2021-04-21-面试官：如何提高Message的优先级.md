---
layout: post
title: é¢è¯•å®˜ï¼šå¦‚ä½•æé«˜Messageçš„ä¼˜å…ˆçº§
author: ä¸è¿‘è§†çš„çŒ«
date: 2021-04-21
categories: blog
tags: []
description: é¢è¯•å®˜ï¼šå¦‚ä½•æé«˜Messageçš„ä¼˜å…ˆçº§
---

## é¢è¯•ç»å†

é¢è¯•å®˜ï¼šçœ‹ä½ ç®€å†ä¸Šå†™ç€çœ‹è¿‡ Handler æœºåˆ¶æºç ï¼Œè¯´ä¸‹å¦‚ä½•æé«˜Messageçš„ä¼˜å…ˆçº§ï¼Ÿ

---

å†…å¿ƒåˆ†æä¸­ï¼š

é¦–å…ˆï¼Œæˆ‘ä»¬å…ˆåˆ†æä¸‹ï¼Œè¿™ä¸ª Message æ˜¯ç”± Handler è¿›è¡Œå‘é€ï¼Œç„¶åæ·»åŠ åˆ° MessageQueue ä¸­ï¼ŒLooper éå† MessageQueue è·å– Message å‡ºæ¥æ‰§è¡Œã€‚

è€Œ MessageQueue æ˜¯é€šè¿‡æ—¶é—´å¯¹ Message è¿›è¡Œæ’åºçš„ï¼Œè‹¥æƒ³æé«˜ Message çš„ä¼˜å…ˆçº§ï¼Œé‚£å°±æ˜¯è¦æŠŠ Message æ’åœ¨ MessageQueue çš„å‰é¢ï¼Œè¿™æ ·å°±ä¼šä¼˜å…ˆæ‰§è¡Œäº†ã€‚

è€Œæˆ‘ä»¬å¸¸ç”¨çš„å‘é€ Message çš„æ–¹æ³•æœ‰ï¼š

- sendMessage
- sendEmptyMessage
- post
- sendMessageDelayed
- sendEmptyMessageDelayed
- postDelayed

å…¶ä¸­å‰ä¸‰ä¸ªæ˜¯æ²¡æœ‰å»¶è¿Ÿçš„ï¼Œåä¸‰ä¸ªå¯ä»¥æ·»åŠ å»¶è¿Ÿã€‚æ—¢ç„¶å‰ä¸‰ä¸ªæ²¡æœ‰å»¶è¿Ÿï¼Œé‚£ä¹ˆä¸€èˆ¬è€Œè¨€å°±ä¼šå…ˆæ’åœ¨ MessageQueue çš„å‰é¢ã€‚

<img src="https://img-blog.csdnimg.cn/20210326220150376.jpg" width = "150" >

è¿™ä¸ªé—®é¢˜å¦‚æ­¤ç®€å•ã€‚

---

ç­”ï¼šä½¿ç”¨`sendMessage`ã€`sendEmptyMessage`ã€`post`å‘é€ Message èƒ½å¤Ÿä½¿å¾— Message æ’åœ¨ MessageQueue å‰é¢ï¼Œæ‰€ä»¥ç”¨è¿™ä¸‰ä¸ªæ–¹æ³•èƒ½å¤Ÿæé«˜ Message çš„ä¼˜å…ˆçº§ã€‚

---

é¢è¯•å®˜ï¼šä¸æ˜¯ã€‚

---

<img src="https://img-blog.csdnimg.cn/20210329222955824.png" width = "120" >

è™½ç„¶çŸ¥é“è‡ªå·±é¢è¯•è·ªäº†ï¼Œä½†æ˜¯è¿˜æ˜¯è¦å¸¦ç€ä»¥ä¸‹å¿ƒæƒ…ç ”ç©¶ä¸‹ï¼Œåˆ°åº•æ˜¯å“ªé‡Œå‡ºé—®é¢˜äº†ï¼Ÿ

<img src="https://img-blog.csdnimg.cn/20210328193903413.png" width = "150" >



## é‡æ–°åˆ†ææµç¨‹

é¦–å…ˆï¼Œæˆ‘ä»¬è¦ç¡®è®¤ä¸‹ï¼ŒMessage åœ¨ MessageQueue çš„æ’åºç¡®å®æ˜¯ä»¥æ—¶é—´è¿›è¡Œæ’åºã€‚

MessageQueue æ’å…¥ Message çš„æ–¹æ³•ï¼š`enqueueMessage(Message msg, long when)`ï¼Œwhen å…¶å®å°±æ˜¯å»¶è¿Ÿçš„æ—¶é—´ã€‚

```
    boolean enqueueMessage(Message msg, long when) {
        ...

        synchronized (this) {
            ...
            msg.when = when;
            Message p = mMessages;
            ...
            if (...) {
                ...
            } else {
                ...
                Message prev;
                //æ ¸å¿ƒåœ¨è¿™é‡Œï¼Œå¯¹ MessageQueue è¿›è¡Œéå†
                //ä»¥ when çš„å€¼ä»å°åˆ°å¤§è¿›è¡Œæ’åº
                for (;;) {
                    prev = p;
                    p = p.next;
                    if (p == null || when < p.when) {
                        break;
                    }
                    ...
                }
                msg.next = p; // invariant: p == prev.next
                prev.next = msg;
            }
            ...
        }
        return true;
    }
```

é‚£æˆ‘ä»¬çœ‹çœ‹ `sendMessage(Message msg)`çš„ when å€¼æ˜¯å¤šå°‘ï¼š

```
    public final boolean sendMessage(Message msg){
        return sendMessageDelayed(msg, 0);
    }
```

`sendMessage`å†…éƒ¨å…¶å®æ˜¯è°ƒç”¨äº†`sendMessageDelayed`æ–¹æ³•ï¼Œå»¶è¿Ÿæ—¶é—´ä¸º 0ã€‚


```
    public final boolean sendMessageDelayed(Message msg, long delayMillis){
        if (delayMillis < 0) {
            delayMillis = 0;
        }
        return sendMessageAtTime(msg, SystemClock.uptimeMillis() + delayMillis);
    }
```

`sendMessageDelayed`å†…éƒ¨è°ƒç”¨çš„æ˜¯`sendMessageAtTime`æ–¹æ³•ï¼Œè¿™é‡Œçš„æ—¶é—´ä¸º `SystemClock.uptimeMillis() + å»¶è¿Ÿæ—¶é—´`ï¼Œä¹Ÿå°±æ˜¯`SystemClock.uptimeMillis() + 0`ã€‚

```
    public boolean sendMessageAtTime(Message msg, long uptimeMillis) {
        MessageQueue queue = mQueue;
        if (queue == null) {
            RuntimeException e = new RuntimeException(
                    this + " sendMessageAtTime() called with no mQueue");
            Log.w("Looper", e.getMessage(), e);
            return false;
        }
        return enqueueMessage(queue, msg, uptimeMillis);
    }
```

`sendMessageAtTime`å†…éƒ¨è°ƒç”¨äº†`enqueueMessage`ã€‚

```
    private boolean enqueueMessage(MessageQueue queue, Message msg, long uptimeMillis) {
        msg.target = this;
        if (mAsynchronous) {
            msg.setAsynchronous(true);
        }
        return queue.enqueueMessage(msg, uptimeMillis);
    }
```
`enqueueMessage`é‡Œé¢è°ƒç”¨äº†`queue.enqueueMessage`ï¼Œä¹Ÿå°±æ˜¯æˆ‘ä»¬æœ€å¼€å§‹åˆ†æçš„MessageQueue æ’å…¥ Message çš„æ–¹æ³•ã€‚

æ€»ç»“æ¥è¯´ï¼Œé€šè¿‡`sendMessage(Message msg)`å‘é€ Messageï¼Œå…¶ when å¹¶ä¸æ˜¯ä¸º 0ï¼Œè€Œæ˜¯`SystemClock.uptimeMillis() + 0`ã€‚

è€Œ`SystemClock.uptimeMillis()`è¡¨ç¤ºç³»ç»Ÿå¼€æœºåˆ°å½“å‰çš„æ—¶é—´æ€»æ•°ï¼Œå•ä½æ˜¯æ¯«ç§’ã€‚

em...

é‚£æœ‰æ²¡æœ‰åŠæ³•æŠŠ when æ”¹ä¸º 0ã€‚è¿™æ ·çš„è¯ï¼Œå‘é€çš„ Message æ¶ˆæ¯å°±ä¼šä¸€å®šæ’åœ¨ MessageQueue å‰é¢äº†ï¼Œå› ä¸º 0 æ˜¯æœ€å°çš„äº†ã€‚ï¼ˆå½“ç„¶ï¼Œæ€»ä¸å¯èƒ½å‡ºç°è´Ÿæ•°å§ï¼ŸğŸ˜‚ï¼‰

## å¯»æ‰¾ç­”æ¡ˆ

æˆ‘ä»¬å†çœ‹ä¸‹ Handler å‘é€ Message æ¶ˆæ¯æœ‰ä»€ä¹ˆæ–¹æ³•ï¼š

<img src="https://img-blog.csdnimg.cn/20210420232707177.png" width = "500" >

å—¯ï¼Ÿè¿™ä¸ªæ–¹æ³•æ²¡æœ‰è§è¿‡ï¼š

```
    public final boolean sendMessageAtFrontOfQueue(Message msg) {
        MessageQueue queue = mQueue;
        if (queue == null) {
            RuntimeException e = new RuntimeException(
                this + " sendMessageAtTime() called with no mQueue");
            Log.w("Looper", e.getMessage(), e);
            return false;
        }
        return enqueueMessage(queue, msg, 0);
    }
```

sendMessageAtFrontOfQueue å†…éƒ¨è°ƒç”¨çš„æ˜¯`enqueueMessage`ã€‚

```
    private boolean enqueueMessage(MessageQueue queue, Message msg, long uptimeMillis) {
        msg.target = this;
        if (mAsynchronous) {
            msg.setAsynchronous(true);
        }
        return queue.enqueueMessage(msg, uptimeMillis);
    }
```

**Whatï¼ŸuptimeMillis ä¸º 0 ï¼ï¼** è¿™ä¸ªä¸å°±æ˜¯æˆ‘ä»¬æ‰€æƒ³è¦çš„å—ï¼Ÿ

å…ˆæ·¡å®šï¼Œsend å’Œ post æ–¹æ³•ç›¸å¯¹åº”çš„ï¼Œæ‰€ä»¥ post åº”è¯¥ä¹Ÿæœ‰ä¸€ä¸ªè¿™æ ·çš„æ–¹æ³•ï¼š

```
    public final boolean postAtFrontOfQueue(Runnable r){
        return sendMessageAtFrontOfQueue(getPostMessage(r));
    }
```

å¥½äº†ï¼Œç»“æœç»ˆäºå‡ºæ¥äº†ï¼ï¼ï¼

ä½¿ç”¨ä»¥ä¸‹æ–¹æ³•å¯ä»¥æé«˜Messageçš„ä¼˜å…ˆçº§ï¼š

- **sendMessageAtFrontOfQueue**
- **postAtFrontOfQueue**

æ–°çŸ¥è¯†ï¼ŒGETï¼

<img src="https://img-blog.csdnimg.cn/20210326220150376.jpg" width = "150" >


## çŒœä½ å–œæ¬¢

- <a href="https://juejin.cn/post/6945499630276706311">åˆ¶ä½œä¸€ä¸ªæ°¸è¿œä¸ä¼šå´©æºƒçš„App</a>
- <a href="https://juejin.cn/post/6945380865404829703">è‡ªå®šä¹‰Gradle Plugin+å­—èŠ‚ç æ’æ¡©</a>
- <a href="https://juejin.cn/post/6943829469106798629">ä»æ‰‹å†™ButterKnifeåˆ°æŒæ¡æ³¨è§£ã€AnnotationProcessor</a>
- <a href="https://juejin.cn/post/6942309139947356191">æ¥ï¼Œå¸¦ä½ æ‰‹å†™ä¸ªæ€§èƒ½æ£€æµ‹å·¥å…·</a>

---

è¿™æ˜¯æˆ‘çš„å…¬ä¼—å·ï¼Œå…³æ³¨è·å–ç¬¬ä¸€ä¿¡æ¯ï¼ï¼æ¬¢è¿å…³æ³¨æ”¯æŒä¸‹ï¼Œè°¢è°¢ï¼

<img src="https://img-blog.csdnimg.cn/20210328021432830.png" width = "500" >









