---
layout: post
title: é‡æ‹¾ Kotlin åç¨‹â€”â€”å¼‚å¸¸å‰–æï¼ˆ4ï¼‰
author: ä¸è¿‘è§†çš„çŒ«
date: 2022-05-25
categories: blog
tags: []
description: é‡æ‹¾ Kotlin åç¨‹â€”â€”å¼‚å¸¸å‰–æï¼ˆ4ï¼‰
---


# å‰è¨€

æˆ‘ä»¬é€šè¿‡[ä¸Šä¸€ç¯‡æ–‡ç« ](https://juejin.cn/post/7094946159303049224)çŸ¥é“ï¼Œåœ¨ Android ä¸­ï¼Œå‡å¦‚çº¿ç¨‹å‘ç”Ÿäº†å¼‚å¸¸ï¼Œä¼šå¯¼è‡´ App ç›´æ¥é€€å‡ºï¼Œé‚£æˆ‘ä»¬æ¥çœ‹çœ‹ï¼Œåç¨‹å‘ç”Ÿå¼‚å¸¸åï¼Œç°è±¡ä¼šæ€ä¹ˆæ ·ã€‚

ç¤ºä¾‹ä»£ç ï¼š


```
    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setContentView(R.layout.activity_main)

        GlobalScope.launch {
            throw NullPointerException()
        }
    }
```

æ—¥å¿—è¾“å‡ºï¼š

```
2022-05-09 10:48:34.529 3946-3978/com.bjsdm.testkotlin E/AndroidRuntime: FATAL EXCEPTION: DefaultDispatcher-worker-1
    Process: com.bjsdm.testkotlin, PID: 3946
    java.lang.NullPointerException
        at com.bjsdm.testkotlin.MainActivity$onCreate$1.invokeSuspend(MainActivity.kt:17)
        at kotlin.coroutines.jvm.internal.BaseContinuationImpl.resumeWith(ContinuationImpl.kt:33)
        at kotlinx.coroutines.DispatchedTask.run(DispatchedTask.kt:106)
        at kotlinx.coroutines.scheduling.CoroutineScheduler.runSafely(CoroutineScheduler.kt:571)
        at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.executeTask(CoroutineScheduler.kt:750)
        at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.runWorker(CoroutineScheduler.kt:678)
        at kotlinx.coroutines.scheduling.CoroutineScheduler$Worker.run(CoroutineScheduler.kt:665)
```

em...ä¹Ÿæ˜¯ä¼šå¯¼è‡´ App å´©æºƒã€‚

é‚£æˆ‘ä»¬æ¥ä¸‹æ¥å°±åˆ†æä¸‹ï¼Œå¯¹äºåç¨‹å‘ç”Ÿäº†å¼‚å¸¸ï¼Œæˆ‘ä»¬è¯¥å¦‚ä½•è¿›è¡Œå¤„ç†ã€‚

ï¼ˆè¯´å¥é¢˜å¤–è¯ï¼Œå…¶å®ï¼Œç›¸å¯¹äº Kotlinï¼Œä¸ªäººè¿˜æ˜¯æ¯”è¾ƒå»ºè®®å…ˆç†Ÿæ‚‰ä¸‹ Javaï¼Œæ‰€ä»¥ï¼Œç”±äºåç¨‹æ˜¯åŸºäºçº¿ç¨‹ï¼Œé’ˆå¯¹äºåç¨‹çš„å¼‚å¸¸å¤„ç†ï¼Œå…¶å®æˆ‘ä»¬å¯ä»¥å…ˆçœ‹çœ‹[çº¿ç¨‹å¼‚å¸¸è¯¥æ€ä¹ˆæ ·å¤„ç†](https://juejin.cn/post/7090098229177483295)ï¼‰

# å¼‚å¸¸æ•è·

## CoroutineExceptionHandler

æœ€å…ˆæ‰“å¤´é˜µçš„æ˜¯ CoroutineExceptionHandlerï¼ŒCoroutineExceptionHandler å…¶å®ç›¸å½“äº UncaughtExceptionHandlerï¼Œå¯ä»¥é’ˆå¯¹æ€§çš„ç»™æŸä¸ªæˆ–æŸäº›åç¨‹è¿›è¡Œå¼‚å¸¸æ•è·ã€‚å…·ä½“ç”¨æ³•å¦‚ä¸‹ï¼š

```
    val exceptionHandler = CoroutineExceptionHandler { _, throwable ->
        println("æ•è·åˆ°å¼‚å¸¸: $throwable")
    }

    GlobalScope.launch(exceptionHandler){
        throw NullPointerException()
    }
```

æ—¥å¿—è¾“å‡ºï¼š

```
I/System.out: æ•è·åˆ°å¼‚å¸¸: java.lang.NullPointerException
```

è¿™æ ·å°±èƒ½å¤Ÿæ•è·åˆ°ç›¸åº”çš„åç¨‹å¼‚å¸¸äº†ï¼Œå¹¶ä¸”æ•è·å¼‚å¸¸åï¼ŒApp ä¸ä¼šå´©æºƒã€‚ä¸æ­¤ç›¸åº”çš„ï¼Œè¿˜å¯ä»¥è®¾ç½®ä¸€ä¸ªå…¨å±€çš„åç¨‹å¼‚å¸¸æ•è·ã€‚

## å…¨å±€ CoroutineExceptionHandler

é¦–å…ˆï¼Œæˆ‘ä»¬éœ€è¦å†™ä¸ªå¼‚å¸¸çš„é›†æˆç±»ï¼Œè¿™é‡Œæˆ‘å‘½åä¸º `GlobalCoroutineExceptionHandler`:

```
class GlobalCoroutineExceptionHandler: CoroutineExceptionHandler {
    override val key: CoroutineContext.Key<*> = CoroutineExceptionHandler

    override fun handleException(context: CoroutineContext, throwable: Throwable) {
        println("å…¨å±€å¼‚å¸¸æ•è·: $throwable")
    }
}
```

åœ¨ main çš„ç›®å½•ä¸‹æ–°å»ºç›®å½• `resources/META-INF/services`ï¼Œç„¶ååˆ›å»º `kotlinx.coroutines.CoroutineExceptionHandler` æ–‡ä»¶ï¼Œå†åœ¨æ–‡ä»¶é‡Œé¢å¡«å†™åˆšåˆšæ–°å»ºçš„ GlobalCoroutineExceptionHandler ç±»çš„å…¨è·¯å¾„ã€‚å…·ä½“å¯ä»¥çœ‹ä¸‹å›¾ï¼š

![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img-blog.csdnimg.cn/b5614cf1c4564d15b39c910461304595.png#pic_center)

å†™ä¸ªå¼‚å¸¸è¯•è¯•ï¼š

```
    GlobalScope.launch{
        throw NullPointerException()
    }
```

æ—¥å¿—è¾“å‡ºï¼š

```
I/System.out: å…¨å±€å¼‚å¸¸æ•è·: java.lang.NullPointerException
```

ä¸è¿‡ï¼Œè¿™é‡Œæœ‰ä¸€ç‚¹è¦æ³¨æ„ï¼Œè¿™é‡Œçš„å…¨å±€å¼‚å¸¸æ•è·ï¼Œå…¶å®å¹¶ä¸ç®—æ•è·ï¼ŒApp è¿˜æ˜¯ä¼šå´©æºƒçš„ï¼Œåªä¸è¿‡å¯ä»¥åœ¨å‘ç”Ÿåç¨‹å¼‚å¸¸çš„æ—¶å€™ï¼Œå¯ä»¥è¿›è¡Œä¸€äº›æ—¥å¿—è®°å½•ç­‰ã€‚

## try catch

æ²¡æƒ³åˆ°å§ï¼Ÿåç¨‹å¼‚å¸¸ä¹Ÿæ˜¯å¯ä»¥ `try catch` çš„ï¼Œä¸è¿‡ï¼Œè¿™ä¸ªåªé’ˆå¯¹äºå…·æœ‰è¿”å›å€¼çš„åç¨‹æ“ä½œï¼Œå…·ä½“çš„å®ç°å¯ä»¥çœ‹çœ‹ [è¿™ç¯‡æ–‡ç« ](https://juejin.cn/post/7094891417868173348)ï¼Œè‹¥ä½ å¯¹äºä¸ºä»€ä¹ˆèƒ½å¤Ÿ `try catch` æœ‰ç–‘æƒ‘ï¼Œå¯ä»¥çœ‹çœ‹ [è¿™ç¯‡æ–‡ç« ](https://juejin.cn/post/7090123774628102175) ä½œä¸ºå‚è€ƒã€‚

å¦å¤–ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥åˆ©ç”¨æ‰©å±•å‡½æ•°è¿›è¡Œ try catch æ“ä½œï¼š

```
fun <T> CoroutineScope.catchLaunch(
    dispatcher: CoroutineDispatcher = Dispatchers.Default,
    block: suspend CoroutineScope.() -> T
) = launch(dispatcher) {
    try {
        block()
    } catch (e: Exception) {
        if (e !is CancellationException) {
            println("æ•è·åˆ°å¼‚å¸¸ï¼š$e")
        }
    }
}
```

ä½¿ç”¨æ–¹å¼ï¼š

```
    GlobalScope.catchLaunch {
        throw NullPointerException()
    }
```

æ—¥å¿—è¾“å‡ºï¼š

```
I/System.out: æ•è·åˆ°å¼‚å¸¸ï¼šjava.lang.NullPointerException
```

åœ¨è¿™é‡Œï¼Œåšäº†ä¸€ä¸ªå°ä¼˜åŒ–ï¼Œå°±æ˜¯ `e !is CancellationException` çš„æ—¶å€™æ‰è¿›è¡Œå¼‚å¸¸è¾“å‡ºï¼Œè¿™æ˜¯å› ä¸ºå½“åç¨‹åœ¨è°ƒç”¨æŒ‚èµ·å‡½æ•°çš„æ—¶å€™ï¼Œè‹¥å·²è°ƒç”¨ `cancel()`ï¼Œå°±ä¼šæŠ›å‡º `CancellationException`ï¼Œåªæ˜¯åç¨‹å¯¹äºè¯¥å¼‚å¸¸é™é»˜å¤„ç†äº†ã€‚

ğŸŒ°ï¼š

```
    val job = GlobalScope.catchLaunch {
        try {
            delay(10000)
        } catch (e: Exception) {
            println("æ•è·åˆ°å¼‚å¸¸ï¼š$e")
        }
    }
    job.cancel()
```


## DefaultUncaughtExceptionHandler

ç›¸ä¿¡å¤§å®¶éƒ½çŸ¥é“ï¼Œå¯ä»¥ä½¿ç”¨ DefaultUncaughtExceptionHandler æ•è·å…¨éƒ¨çº¿ç¨‹çš„å¼‚å¸¸ï¼Œè€Œåç¨‹æ˜¯åŸºäºçº¿ç¨‹çš„ï¼Œæ‰€ä»¥ï¼Œ
DefaultUncaughtExceptionHandler ä¹Ÿæ˜¯å¯ä»¥æ•è·åç¨‹çš„å¼‚å¸¸ï¼š

```
    Thread.setDefaultUncaughtExceptionHandler { t, e -> println("Threadåç§°ï¼š ${t.name} ,Throwable: $e ") }

    GlobalScope.launch {
        throw NullPointerException()
    }
```

æ—¥å¿—è¾“å‡ºï¼š

```
I/System.out: Threadåç§°ï¼š DefaultDispatcher-worker-1 ,Throwable: java.lang.NullPointerException
```

ä»¥ä¸Šå†…å®¹å°±æ˜¯å¯¹äºå¼‚å¸¸æ•è·å¤„ç†çš„å‡ ç§æ–¹å¼ï¼Œä½†æ˜¯ï¼Œä¸çº¿ç¨‹ä¸åŒçš„æ˜¯ï¼Œæ¯ä¸ªçº¿ç¨‹çš„è¿è¡Œéƒ½æ˜¯ç›¸å¯¹ç‹¬ç«‹çš„ï¼Œä¸€ä¸ªçº¿ç¨‹å‘ç”Ÿå¼‚å¸¸ï¼Œå¹¶ä¸ä¼šå½±å“å…¶å®ƒçº¿ç¨‹çš„è¿è¡Œï¼Œä½†æ˜¯ï¼Œåç¨‹å°±ä¸å¤ªä¸€æ ·ï¼Œåœ¨åç¨‹ä¸­ï¼Œå‡å¦‚æœ‰ä¸€ä¸ªåç¨‹å‘ç”Ÿäº†å¼‚å¸¸ï¼Œå°±æœ‰å¯èƒ½ä¼šå½±å“åˆ°å…¶å®ƒåç¨‹çš„è¿è¡Œï¼Œè¯·æ³¨æ„ï¼Œâ€œæœ‰å¯èƒ½â€ï¼Œæ‰€ä»¥ï¼Œæˆ‘ä»¬è¿˜éœ€è¦åˆ†æƒ…å†µè¿›è¡Œå¤„ç†ã€‚

# å¼‚å¸¸ä¼ æ’­

## é»˜è®¤æƒ…å†µ
é¦–å…ˆï¼Œæˆ‘ä»¬è¿˜æ˜¯å…ˆçœ‹çœ‹ä¸ªæ —å­ï¼š

```
    val exceptionHandler = CoroutineExceptionHandler { _, throwable ->
        println("æ•è·åˆ°å¼‚å¸¸: $throwable")
    }

    GlobalScope.launch(exceptionHandler){
        launch {
            println("launch1 æ­£åœ¨è¿è¡Œ")
            delay(1000)
            throw NullPointerException()
        }
        launch {
            println("launch2 æ­£åœ¨è¿è¡Œ")
            delay(2000)
            println("launch2 è¿è¡Œå®Œæˆ")
        }
    }
```

æ—¥å¿—è¾“å‡ºï¼š

```
I/System.out: launch1 æ­£åœ¨è¿è¡Œ
I/System.out: launch2 æ­£åœ¨è¿è¡Œ
I/System.out: æ•è·åˆ°å¼‚å¸¸: java.lang.NullPointerException
```

è¿™é‡Œå¾ˆæ˜æ˜¾åœ°çœ‹å‡ºï¼Œlaunch1 çš„å´©æºƒä¼šå¯¼è‡´ launch2 çš„é€€å‡ºã€‚

## coroutineScope

```
    val exceptionHandler = CoroutineExceptionHandler { _, throwable ->
        println("æ•è·åˆ°å¼‚å¸¸: $throwable")
    }

    GlobalScope.launch(exceptionHandler){
        coroutineScope {
            launch {
                println("launch1 æ­£åœ¨è¿è¡Œ")
                delay(1000)
                throw NullPointerException()
            }
            launch {
                println("launch2 æ­£åœ¨è¿è¡Œ")
                delay(2000)
                println("launch2 è¿è¡Œå®Œæˆ")
            }
        }
    }
```


ç»“è®ºè·Ÿé»˜è®¤çš„æƒ…å†µä¸€è‡´ã€‚

## supervisorScope
å°† coroutineScope æ›¿æ¢æˆ supervisorScopeã€‚

æ—¥å¿—è¾“å‡ºï¼š

```
I/System.out: launch1 æ­£åœ¨è¿è¡Œ
I/System.out: launch2 æ­£åœ¨è¿è¡Œ
I/System.out: æ•è·åˆ°å¼‚å¸¸: java.lang.NullPointerException
I/System.out: launch2 è¿è¡Œå®Œæˆ
```

åœ¨ supervisorScope ä¸­ï¼Œå‡å¦‚ä¸€ä¸ªåç¨‹å‘ç”Ÿäº†å¼‚å¸¸ï¼Œå¹¶ä¸ä¼šå½±å“åˆ°å…¶å®ƒåç¨‹çš„è¿è¡Œã€‚

## ä¸Šä¸‹ä¼ é€’

åˆšåˆšæˆ‘ä»¬æ¢ç©¶çš„åç¨‹åŸºæœ¬ä¸Šéƒ½æ˜¯åŒçº§çš„ï¼Œé‚£æˆ‘ä»¬æ¥çœ‹çœ‹ï¼Œä¸Šä¸‹çº§çš„åç¨‹çš„å¼‚å¸¸åˆæ˜¯æ€ä¹ˆä¼ æ’­çš„ï¼š

```
    val exceptionHandler = CoroutineExceptionHandler { _, throwable ->
        println("exceptionHandler: æ•è·åˆ°å¼‚å¸¸: $throwable")
    }
    val childExceptionHandler = CoroutineExceptionHandler { _, throwable ->
        println("childExceptionHandler: æ•è·åˆ°å¼‚å¸¸: $throwable")
    }

    GlobalScope.launch(exceptionHandler) {
        println("launch1 æ­£åœ¨æ‰§è¡Œ")
        launch (childExceptionHandler){
            println("launch2 æ­£åœ¨æ‰§è¡Œ")
            throw NullPointerException()
        }
        delay(2000)
        println("launch1 æ‰§è¡Œå®Œæˆ")
    }
```

æ—¥å¿—è¾“å‡ºï¼š

```
I/System.out: launch1 æ­£åœ¨æ‰§è¡Œ
I/System.out: launch2 æ­£åœ¨æ‰§è¡Œ
I/System.out: exceptionHandler: æ•è·åˆ°å¼‚å¸¸: java.lang.NullPointerException
```

æˆ‘ä»¬åˆæ­¥å¾—åˆ°ä»¥ä¸‹ç»“è®ºï¼š

- å­åç¨‹çš„å¼‚å¸¸å´©æºƒä¼šå½±å“åˆ°çˆ¶åç¨‹çš„è¿è¡Œã€‚
- å½“å­çº¿ç¨‹å‘ç”Ÿå¼‚å¸¸çš„æ—¶å€™ï¼Œå…¶å¼‚å¸¸ä¸ä¼šè¢«å­åç¨‹çš„ CoroutineExceptionHandler è¿›è¡Œæ•è·ï¼Œè€Œæ˜¯ä¼šè¢«çˆ¶åç¨‹çš„ CoroutineExceptionHandler æ•è·ã€‚






















